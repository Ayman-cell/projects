<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Diagnostics - Windy Safi</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #0a0e1a;
      color: #eaeef6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #ff6a1a;
      border-bottom: 2px solid #ff6a1a;
      padding-bottom: 10px;
    }
    .section {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .section h2 {
      color: #ff6a1a;
      margin-top: 0;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 12px;
    }
    .status.ok {
      background: #10b981;
      color: white;
    }
    .status.error {
      background: #ef4444;
      color: white;
    }
    .status.no_data {
      background: #f59e0b;
      color: white;
    }
    button {
      background: linear-gradient(90deg, #ff7a18, #ff4e50);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    pre {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    .loading {
      color: #ff6a1a;
      font-style: italic;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th {
      background: rgba(255,106,26,0.2);
      color: #ff6a1a;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagnostics API - Windy Safi</h1>
    
    <div class="section">
      <h2>Tests rapides</h2>
      <button onclick="testHealth()">Test Sant√© Serveur</button>
      <button onclick="testOpenMeteo()">Test API Open-Meteo</button>
      <button onclick="testForecast()">Test Pr√©visions</button>
      <button onclick="fullDiagnostics()">Diagnostics Complets</button>
      <div id="results"></div>
    </div>

    <div class="section">
      <h2>R√©sultats</h2>
      <pre id="output">Cliquez sur un bouton pour lancer un test...</pre>
    </div>
  </div>

  <script>
    async function testHealth() {
      showLoading('Test de sant√© du serveur...');
      try {
        const resp = await fetch('/api/health');
        const data = await resp.json();
        showResult('Sant√© du serveur', data, true);
      } catch (e) {
        showResult('Sant√© du serveur', { error: e.message }, false);
      }
    }

    async function testOpenMeteo() {
      showLoading('Test de tous les mod√®les Open-Meteo...');
      try {
        const resp = await fetch('/api/test/openmeteo');
        const data = await resp.json();
        showResult('Test Open-Meteo', data, true);
      } catch (e) {
        showResult('Test Open-Meteo', { error: e.message }, false);
      }
    }

    async function testForecast() {
      showLoading('Test des pr√©visions...');
      try {
        const resp = await fetch('/api/test/forecast');
        const data = await resp.json();
        showResult('Test Pr√©visions', data, true);
      } catch (e) {
        showResult('Test Pr√©visions', { error: e.message }, false);
      }
    }

    async function fullDiagnostics() {
      showLoading('Diagnostics complets...');
      try {
        const resp = await fetch('/api/diagnostics');
        const data = await resp.json();
        showResult('Diagnostics Complets', data, true);
      } catch (e) {
        showResult('Diagnostics Complets', { error: e.message }, false);
      }
    }

    function showLoading(msg) {
      document.getElementById('output').textContent = msg + '\n‚è≥ En cours...';
      document.getElementById('results').innerHTML = '';
    }

    function showResult(title, data, success) {
      const output = document.getElementById('output');
      output.textContent = JSON.stringify(data, null, 2);
      
      const results = document.getElementById('results');
      let html = `<h3>${title}</h3>`;
      
      if (data.models) {
        html += '<table><tr><th>Mod√®le</th><th>Statut</th><th>Temps (s)</th><th>Points</th><th>Temp√©rature</th></tr>';
        for (const [model, info] of Object.entries(data.models)) {
          html += `<tr>
            <td><strong>${model}</strong></td>
            <td><span class="status ${info.status}">${info.status.toUpperCase()}</span></td>
            <td>${info.response_time_seconds || '-'}</td>
            <td>${info.data_points || '-'}</td>
            <td>${info.sample_temperature !== null ? info.sample_temperature.toFixed(1) + '¬∞C' : '-'}</td>
          </tr>`;
        }
        html += '</table>';
      }
      
      if (data.tests) {
        html += '<table><tr><th>Heure</th><th>Mod√®le</th><th>Statut</th><th>Temps (s)</th><th>Plage Temp</th></tr>';
        for (const test of data.tests) {
          html += `<tr>
            <td>+${test.hour}h</td>
            <td>${test.model}</td>
            <td><span class="status ${test.status}">${test.status.toUpperCase()}</span></td>
            <td>${test.response_time_seconds || '-'}</td>
            <td>${test.temp_range ? test.temp_range.map(t => t.toFixed(1)).join(' - ') + '¬∞C' : '-'}</td>
          </tr>`;
        }
        html += '</table>';
      }
      
      results.innerHTML = html;
    }

    // Auto-charger les diagnostics au d√©marrage
    window.onload = () => {
      fullDiagnostics();
    };
  </script>
</body>
</html>

